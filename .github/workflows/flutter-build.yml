name: Build Flutter APK

on:
  push:
    branches: [ main, develop, claude/** ]
  pull_request:
    branches: [ main ]
  workflow_dispatch: # Ð ÑƒÑ‡Ð½Ð¾Ð¹ Ð·Ð°Ð¿ÑƒÑÐº

jobs:
  build-apk:
    name: Build Flutter APK
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: 'zulu'
          java-version: '17'

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.16.0'
          channel: 'stable'
          cache: true

      - name: Get dependencies
        working-directory: demo-app/mobile-flutter
        run: flutter pub get

      - name: Create Android platform files
        working-directory: demo-app/mobile-flutter
        run: |
          if [ ! -d "android" ]; then
            echo "Android folder not found, creating..."
            flutter create --platforms android --org com.demoapp --project-name demo_app_mobile .
          else
            echo "Android folder already exists"
          fi

      - name: Update Gradle wrapper to fix Maven 403 errors
        working-directory: demo-app/mobile-flutter/android
        run: |
          echo "=== Updating Gradle configuration ==="

          # Update gradle-wrapper.properties to use Gradle 8.3
          sed -i 's|distributionUrl=.*|distributionUrl=https\\://services.gradle.org/distributions/gradle-8.3-bin.zip|' gradle/wrapper/gradle-wrapper.properties
          echo "âœ“ Updated Gradle wrapper to 8.3"

          # Show current build.gradle content for debugging
          echo "=== Current build.gradle content ==="
          cat build.gradle

          # Update Android Gradle Plugin in all possible formats
          # Format 1: classpath "com.android.tools.build:gradle:X.X.X"
          sed -i 's/com\.android\.tools\.build:gradle:[0-9.]\+/com.android.tools.build:gradle:8.1.0/g' build.gradle

          # Format 2: id "com.android.application" version "X.X.X"
          sed -i 's/id "com\.android\.application" version "[0-9.]\+"/id "com.android.application" version "8.1.0"/g' build.gradle
          sed -i "s/id 'com\.android\.application' version '[0-9.]\+'/id 'com.android.application' version '8.1.0'/g" build.gradle

          echo "âœ“ Updated Android Gradle Plugin to 8.1.0"

          # Show updated build.gradle
          echo "=== Updated build.gradle content ==="
          cat build.gradle

      - name: Analyze code
        working-directory: demo-app/mobile-flutter
        run: flutter analyze
        continue-on-error: true

      - name: Build APK
        working-directory: demo-app/mobile-flutter
        run: flutter build apk --release

      - name: Get version
        id: version
        run: |
          echo "sha_short=$(git rev-parse --short HEAD)" >> $GITHUB_OUTPUT
          echo "branch=$(echo ${GITHUB_REF#refs/heads/} | sed 's/\//-/g')" >> $GITHUB_OUTPUT

      - name: Rename APK
        run: |
          mv demo-app/mobile-flutter/build/app/outputs/flutter-apk/app-release.apk \
             demo-app/mobile-flutter/build/app/outputs/flutter-apk/demo-app-${{ steps.version.outputs.branch }}-${{ steps.version.outputs.sha_short }}.apk

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: flutter-apk-${{ steps.version.outputs.branch }}-${{ steps.version.outputs.sha_short }}
          path: demo-app/mobile-flutter/build/app/outputs/flutter-apk/*.apk
          retention-days: 30

      - name: Create Release (on tag)
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: demo-app/mobile-flutter/build/app/outputs/flutter-apk/*.apk
          generate_release_notes: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Comment PR with APK download link
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v7
        env:
          BRANCH: ${{ steps.version.outputs.branch }}
          SHA_SHORT: ${{ steps.version.outputs.sha_short }}
        with:
          script: |
            const runId = context.runId;
            const repoUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}`;
            const downloadUrl = `${repoUrl}/actions/runs/${runId}`;
            const branch = process.env.BRANCH;
            const shaShort = process.env.SHA_SHORT;

            const message = [
              '## ðŸ“± Flutter APK ÑÐ¾Ð±Ñ€Ð°Ð½ ÑƒÑÐ¿ÐµÑˆÐ½Ð¾!',
              '',
              '**Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ APK:**',
              downloadUrl,
              '',
              '**Ð¤Ð°Ð¹Ð»:** `demo-app-' + branch + '-' + shaShort + '.apk`',
              '',
              '**Ð ÐµÐ¶Ð¸Ð¼:** Termux (localhost:5001/5002/5003)',
              '',
              '### Ð£ÑÑ‚Ð°Ð½Ð¾Ð²ÐºÐ°:',
              '1. Ð¡ÐºÐ°Ñ‡Ð°Ð¹Ñ‚Ðµ APK Ð¸Ð· Ð°Ñ€Ñ‚ÐµÑ„Ð°ÐºÑ‚Ð¾Ð²',
              '2. Ð£ÑÑ‚Ð°Ð½Ð¾Ð²Ð¸Ñ‚Ðµ Ð½Ð° Android',
              '3. Ð£Ð±ÐµÐ´Ð¸Ñ‚ÐµÑÑŒ Ñ‡Ñ‚Ð¾ Termux backend Ð·Ð°Ð¿ÑƒÑ‰ÐµÐ½',
              '4. ÐžÑ‚ÐºÑ€Ð¾Ð¹Ñ‚Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ'
            ].join('\n');

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: message
            });

  build-info:
    name: Build Information
    runs-on: ubuntu-latest
    needs: build-apk

    steps:
      - name: Build Summary
        run: |
          echo "## ðŸŽ‰ Flutter APK Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… APK ÑƒÑÐ¿ÐµÑˆÐ½Ð¾ ÑÐ¾Ð±Ñ€Ð°Ð½!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ð”ÐµÑ‚Ð°Ð»Ð¸:" >> $GITHUB_STEP_SUMMARY
          echo "- **Branch:** ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Commit:** ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Flutter:** 3.16.0" >> $GITHUB_STEP_SUMMARY
          echo "- **API Mode:** Termux (localhost)" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Ð¡ÐºÐ°Ñ‡Ð°Ñ‚ÑŒ APK:" >> $GITHUB_STEP_SUMMARY
          echo "ÐŸÐµÑ€ÐµÐ¹Ð´Ð¸Ñ‚Ðµ Ð² Actions â†’ Artifacts" >> $GITHUB_STEP_SUMMARY
